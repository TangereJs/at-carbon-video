<link rel="import" href="../tangere/tangere.html">
<link rel="import" href="../at-core-video/at-core-video.html">
<link rel="import" href="../google-youtube/google-youtube.html">
<link rel="import" href="../at-theme/at-theme.html">


<dom-module id="at-carbon-video">
  <template>
    <style include="at-form-common"></style>
    <style>

      :host {
        @apply(--at-form-host)
        display: block;
        box-sizing: border-box;
      }

      :host * {
        box-sizing: border-box;
      }

      :host .google-youtube-container {
        display: flex;
        justify-content: center;
      }

    </style>

    <div id="atContainer" class="at-container">
      <template is="dom-if" if="{{_isCorePlayer(src)}}">
        <at-core-video
          src="{{src}}"
          controls="{{controls}}"
          autoplay="{{autoplay}}"
          loop="{{loop}}"
          thumbnail="{{thumbnail}}"
          preload="{{preload}}"
          muted="{{muted}}"
          videoVolume="{{videoVolume}}"
          autohideControls="{{autohideControls}}"
          currentTime="{{currentTime}}"
        ></at-core-video>
      </template>
      <template is="dom-if" if="{{!_isCorePlayer(src)}}">
        <div class="google-youtube-container">
          <google-youtube
            video-id="{{_extractVideoIdFromUrl(src)}}"
            thumbnail="{{thumbnail}}"
            volume="{{videoVolume}}"
            autoplay="{{_computeAutoplay(autoplay)}}"
            start-time="{{currentTime}}"
          ></google-youtube>
        </div>
      </template>
  </div>

  </template>
  <script>
    'use strict';
    Polymer({
      is: 'at-carbon-video',
      properties: {

        /**
         * controls - if true controls will be displayed; false hides the controls
         * this attribute doesn't work with youtube player
         * @property controls
         * @type Boolean
         * @default false
         */
        controls: {
          type: Boolean,
          value: false,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * autoplay - if true video will start playing after it loads
         * @property autoplay
         * @type Boolean
         * @default false
         */
        autoplay: {
          type: Boolean,
          value: false,
          notify: true
        },

        /**
         * loop - if true video will be played again from the begining when it finishes
         * this attribute doesn't work with youtube player
         * @property loop
         * @type Boolean
         * @default false
         */
        loop: {
          type: Boolean,
          value: false,
          notify: true
        },

        /**
         * src - path or url to the video file
         * Supply a relative path if video is hosted inside your domain
         * Supply a remote url if video is hosted outside your domain
         * @property src
         * @type String
         * @default ""
         */
        src: {
          type: String,
          value: ""
        },

        /**
         * thumbnail - path or url to the image file that will be displayed as thumbnail
         * @property thumbnail
         * @type String
         * @default ""
         */
        thumbnail: {
          type: String,
          value: ""
        },

        /**
         * preload - if true video will be preloaded; if false it will be loaded on play
         * this attribute doesn't work with youtube player
         * @property preload
         * @type Boolean
         * @default false
         */
        preload: {
          type: Boolean,
          value: false,
          notify: true
        },

        /**
         * muted - true mutes the audio
         * @property muted
         * @type Boolean
         * @default false
         */
        muted: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
          notify: true,
          observer: '_mutedChanged'
        },

        /**
         * videoVolume - audio volume in %
         * min is 0, max is 100
         * @property videoVolume
         * @type Number
         * @default 100
         */
        videoVolume: {
          type: Number,
          value: 100,
          observer: '_videoVolumeChanged'
        },

        /**
         * autohideControls - timeout after video controls are automatically hidden
         * this attribute doesn't work with youtube player
         * @property autohideControls
         * @type Number
         * @default 1000
         */
        autohideControls: {
          type: Number,
          value: 1000
        },

        /**
         * width - width of the video area in px
         * @property width
         * @type Number
         * @default null
         */
        width: {
          type: Number,
          value: null
        },

        /**
         * height - height of the video area in px
         * @property height
         * @type Number
         * @default null
         */
        height: {
          type: Number,
          value: null
        },

        /**
         * currentTime - start time at which video should start in seconds
         * @property currentTime
         * @type Number
         * @default 0
         */
        currentTime: {
          type: Number,
          value: 0
        }

      },

      observers: [
        '_updateDimensions(width, height)',
        '_updateCurrentTime(currentTime)'
      ],

      _isCorePlayer: function(src) {
        function isString(obj) {
          return Object.prototype.toString.call(obj) === "[object String]";
        }
        if (!isString(src) || src === "") {
          return false;
        }

        var isFullUrl = src.indexOf('https://www.youtube.com/watch?v=') > -1;
        var isShortUrl = src.indexOf('https://youtu.be/') > -1;
        var isCorePlayer = (!isFullUrl && isShortUrl) || (isFullUrl && isShortUrl);
        return isCorePlayer;
      },

      /**
       * needed for google-youtube because it expects video ids instead of urls
       * extracts youtube video id from youtube url
       */
      _extractVideoIdFromUrl: function(src) {
        var srcParts = src.split('?v=');
        if (srcParts.length !== 2) { return src; }

        var queryParts = srcParts[1].split("&");
        if (!queryParts.length) { return src; }

        return queryParts[0];
      },

      /**
       * needed for google-youtube because plain numbers do not work
       * adds px to dim which is a number
       */
      _addPxToDimension: function(dim) {
        return dim + 'px';
      },

      /**
       * needed for both players
       * direct binding of width and height doesn't work because value(s) need to be processed before applying
       */
      _updateDimensions: function(width, height) {
        if ([null, ""].indexOf(width) !== -1 || [null, ""].indexOf(height) !== -1) { return; }
        if (isNaN(parseInt(width)) || isNaN(parseInt(height))) { return; }

        var corePlayer = this.$$('at-core-video');
        var googleYoutube = this.$$('google-youtube');

        if (corePlayer) {
          corePlayer.width = width;
          corePlayer.height = height;
        } else if (googleYoutube) {
          googleYoutube.width = this._addPxToDimension(width);
          googleYoutube.height = this._addPxToDimension(height);
        }
      },

      /**
       * needed for at-core-player
       * for "reasons" when current-time is set as attribute on at-carbon-video, data binding for currentTime to at-core-player doesn't work
       * so its done by code
       */
      _updateCurrentTime: function(currentTime) {
        var self = this;
        this.$.atContainer.addEventListener('dom-change', function(event) {
          var currentTime1 = parseFloat(currentTime);
          if (isNaN(currentTime1)) { return; }

          var corePlayer = self.$$('at-core-video');
          if (corePlayer) {
            corePlayer.currentTime = currentTime1;
          }

          /**
           * because google-youtube is f***ing garbage and it doesn't provide a way to set video start time
           * hacks such as this one bellow are required in year 2016 (December! FFS, its December and this is needed! WTF?!)
           * And no. google-youtube.currenttime property is useless; it just holds the value in seconds of for how long video has been played
           * its utterly unused in initialization of any kind
           */
          var googleYoutube = self.$$('google-youtube');
          var updatedCurrentTime = false;
          if (googleYoutube) {
            googleYoutube.addEventListener('state-changed', function(event) {
              if (googleYoutube.state === 1 && !updatedCurrentTime) {
                // value of 1 stands for 'playing' state
                updatedCurrentTime = true;
                googleYoutube.seekTo(currentTime1);
              }
            });
          }
        });

      },

      /**
       * needed for google-youtube because boolean doesn't work
       * if autoplay is true returns 1, otherwise returns 0
       */
      _computeAutoplay: function(autoplay) {
        return autoplay ? 1 : 0;
      },

      /**
       * needed for google-youtube because there is no observer for volume
       * adds px to dim which is a number
       */
      _videoVolumeChanged: function (newValue, oldValue) {
        var googleYoutube = this.$$('google-youtube');
        if (googleYoutube) {
          googleYoutube.setVolume(newValue);
        }
      },

      /**
       * needed for google-youtube because there is no muted attribute
       * if true mutes the youtube player; otherwise unmutes the player
       */
      _mutedChanged: function(newValue, oldValue) {
        var googleYoutube = this.$$('google-youtube');
        if (googleYoutube) {
          var result = newValue ? googleYoutube.mute() : googleYoutube.unMute();
        }
      }
    });
  </script>
</dom-module>
